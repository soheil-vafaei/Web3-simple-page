{"ast":null,"code":"import { parse, SelectorType } from \"css-what\";\nimport boolbase from \"boolbase\";\nimport sortRules, { isTraversal } from \"./sort.js\";\nimport { compileGeneralSelector } from \"./general.js\";\nimport { ensureIsTag, PLACEHOLDER_ELEMENT } from \"./pseudo-selectors/subselects.js\";\n/**\n * Compiles a selector to an executable function.\n *\n * @param selector Selector to compile.\n * @param options Compilation options.\n * @param context Optional context for the selector.\n */\n\nexport function compile(selector, options, context) {\n  const next = compileUnsafe(selector, options, context);\n  return ensureIsTag(next, options.adapter);\n}\nexport function compileUnsafe(selector, options, context) {\n  const token = typeof selector === \"string\" ? parse(selector) : selector;\n  return compileToken(token, options, context);\n}\n\nfunction includesScopePseudo(t) {\n  return t.type === SelectorType.Pseudo && (t.name === \"scope\" || Array.isArray(t.data) && t.data.some(data => data.some(includesScopePseudo)));\n}\n\nconst DESCENDANT_TOKEN = {\n  type: SelectorType.Descendant\n};\nconst FLEXIBLE_DESCENDANT_TOKEN = {\n  type: \"_flexibleDescendant\"\n};\nconst SCOPE_TOKEN = {\n  type: SelectorType.Pseudo,\n  name: \"scope\",\n  data: null\n};\n/*\n * CSS 4 Spec (Draft): 3.4.1. Absolutizing a Relative Selector\n * http://www.w3.org/TR/selectors4/#absolutizing\n */\n\nfunction absolutize(token, _ref, context) {\n  let {\n    adapter\n  } = _ref;\n  // TODO Use better check if the context is a document\n  const hasContext = !!(context === null || context === void 0 ? void 0 : context.every(e => {\n    const parent = adapter.isTag(e) && adapter.getParent(e);\n    return e === PLACEHOLDER_ELEMENT || parent && adapter.isTag(parent);\n  }));\n\n  for (const t of token) {\n    if (t.length > 0 && isTraversal(t[0]) && t[0].type !== SelectorType.Descendant) {// Don't continue in else branch\n    } else if (hasContext && !t.some(includesScopePseudo)) {\n      t.unshift(DESCENDANT_TOKEN);\n    } else {\n      continue;\n    }\n\n    t.unshift(SCOPE_TOKEN);\n  }\n}\n\nexport function compileToken(token, options, context) {\n  var _a;\n\n  token.forEach(sortRules);\n  context = (_a = options.context) !== null && _a !== void 0 ? _a : context;\n  const isArrayContext = Array.isArray(context);\n  const finalContext = context && (Array.isArray(context) ? context : [context]); // Check if the selector is relative\n\n  if (options.relativeSelector !== false) {\n    absolutize(token, options, finalContext);\n  } else if (token.some(t => t.length > 0 && isTraversal(t[0]))) {\n    throw new Error(\"Relative selectors are not allowed when the `relativeSelector` option is disabled\");\n  }\n\n  let shouldTestNextSiblings = false;\n  const query = token.map(rules => {\n    if (rules.length >= 2) {\n      const [first, second] = rules;\n\n      if (first.type !== SelectorType.Pseudo || first.name !== \"scope\") {// Ignore\n      } else if (isArrayContext && second.type === SelectorType.Descendant) {\n        rules[1] = FLEXIBLE_DESCENDANT_TOKEN;\n      } else if (second.type === SelectorType.Adjacent || second.type === SelectorType.Sibling) {\n        shouldTestNextSiblings = true;\n      }\n    }\n\n    return compileRules(rules, options, finalContext);\n  }).reduce(reduceRules, boolbase.falseFunc);\n  query.shouldTestNextSiblings = shouldTestNextSiblings;\n  return query;\n}\n\nfunction compileRules(rules, options, context) {\n  var _a;\n\n  return rules.reduce((previous, rule) => previous === boolbase.falseFunc ? boolbase.falseFunc : compileGeneralSelector(previous, rule, options, context, compileToken), (_a = options.rootFunc) !== null && _a !== void 0 ? _a : boolbase.trueFunc);\n}\n\nfunction reduceRules(a, b) {\n  if (b === boolbase.falseFunc || a === boolbase.trueFunc) {\n    return a;\n  }\n\n  if (a === boolbase.falseFunc || b === boolbase.trueFunc) {\n    return b;\n  }\n\n  return function combine(elem) {\n    return a(elem) || b(elem);\n  };\n}","map":{"version":3,"mappings":"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","names":["parse","SelectorType","boolbase","sortRules","isTraversal","compileGeneralSelector","ensureIsTag","PLACEHOLDER_ELEMENT","compile","selector","options","context","next","compileUnsafe","adapter","token","compileToken","includesScopePseudo","t","type","Pseudo","name","Array","isArray","data","some","DESCENDANT_TOKEN","Descendant","FLEXIBLE_DESCENDANT_TOKEN","SCOPE_TOKEN","absolutize","hasContext","every","e","parent","isTag","getParent","length","unshift","forEach","_a","isArrayContext","finalContext","relativeSelector","Error","shouldTestNextSiblings","query","map","rules","first","second","Adjacent","Sibling","compileRules","reduce","reduceRules","falseFunc","previous","rule","rootFunc","trueFunc","a","b","combine","elem"],"sourceRoot":"https://raw.githubusercontent.com/fb55/css-select/0f0725a9dfeddd2fdb54eda9656cdbab5bbf6be6/src/","sources":["compile.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"module"}